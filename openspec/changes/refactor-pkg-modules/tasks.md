# pkg 包模块重构任务清单

## 阶段 1: 评估和清理

### 1.1 包使用情况分析
- [ ] 1.1.1 分析 `pkg/credentials` 的使用情况
- [ ] 1.1.2 分析 `pkg/signer` 的使用情况
- [ ] 1.1.3 分析 `pkg/s3utils` 的使用情况
- [ ] 1.1.4 分析 `pkg/set` 的使用情况
- [ ] 1.1.5 检查其他 pkg 包是否被使用

### 1.2 未使用包清理
- [ ] 1.2.1 删除 `pkg/lifecycle`（如果未使用）
- [ ] 1.2.2 删除 `pkg/notification`（如果未使用）
- [ ] 1.2.3 删除 `pkg/policy`（如果未使用）
- [ ] 1.2.4 删除 `pkg/replication`（如果未使用）
- [ ] 1.2.5 删除 `pkg/encrypt`（如果未使用）
- [ ] 1.2.6 删除 `pkg/kvcache`（如果未使用）
- [ ] 1.2.7 删除 `pkg/singleflight`（如果未使用）
- [ ] 1.2.8 删除 `pkg/sse`（如果未使用）
- [ ] 1.2.9 删除 `pkg/tags`（如果未使用）

### 1.3 决策确认
- [ ] 1.3.1 确定 STS 功能保留范围
- [ ] 1.3.2 决定 `pkg/signer` 的处理方案
- [ ] 1.3.3 决定 `pkg/set` 的处理方案

## 阶段 2: pkg/credentials 包重构

### 2.1 准备工作
- [ ] 2.1.1 创建版权声明模板
- [ ] 2.1.2 备份现有测试用例
- [ ] 2.1.3 记录当前 API 接口

### 2.2 核心文件重构
- [ ] 2.2.1 重构 `credentials.go`
  - [ ] 更新版权声明
  - [ ] 重写核心接口
  - [ ] 更新文档注释
  - [ ] 运行测试验证

- [ ] 2.2.2 重构 `static.go`
  - [ ] 更新版权声明
  - [ ] 简化实现
  - [ ] 更新测试用例

- [ ] 2.2.3 合并环境变量凭证为 `env.go`
  - [ ] 合并 `env_aws.go` 和 `env_minio.go`
  - [ ] 统一命名（移除 MinIO 引用）
  - [ ] 支持 AWS 和 RustFS 环境变量
  - [ ] 编写综合测试

- [ ] 2.2.4 合并文件凭证为 `file.go`
  - [ ] 合并 `file_aws_credentials.go` 和 `file_minio_client.go`
  - [ ] 统一接口
  - [ ] 支持多种配置文件格式
  - [ ] 编写综合测试

- [ ] 2.2.5 重构 `chain.go`
  - [ ] 更新版权声明
  - [ ] 优化凭证链逻辑
  - [ ] 更新测试用例

- [ ] 2.2.6 重构 `iam_aws.go` -> `iam.go`
  - [ ] 更新版权声明
  - [ ] 移除 MinIO 特定逻辑
  - [ ] 更新测试用例

### 2.3 STS 功能重构
- [ ] 2.3.1 重构 `assume_role.go`
  - [ ] 更新版权声明
  - [ ] 移除 MinIO 扩展（TokenRevokeType）
  - [ ] 更新文档
  - [ ] 测试验证

- [ ] 2.3.2 重构 `sts_web_identity.go`
  - [ ] 更新版权声明
  - [ ] 简化实现
  - [ ] 更新测试

- [ ] 2.3.3 评估 `sts_client_grants.go`
  - [ ] 确定是否保留
  - [ ] 如保留，更新版权和实现
  - [ ] 如删除，移除相关引用

- [ ] 2.3.4 评估 `sts_custom_identity.go`
  - [ ] 确定是否保留
  - [ ] 如保留，更新版权和实现
  - [ ] 如删除，移除相关引用

- [ ] 2.3.5 评估 `sts_ldap_identity.go`
  - [ ] 确定是否保留
  - [ ] 如保留，更新版权和实现
  - [ ] 如删除，移除相关引用

- [ ] 2.3.6 评估 `sts_tls_identity.go`
  - [ ] 确定是否保留
  - [ ] 如保留，更新版权和实现
  - [ ] 如删除，移除相关引用

### 2.4 辅助文件重构
- [ ] 2.4.1 重构 `error_response.go` -> `error.go`
  - [ ] 更新版权声明
  - [ ] 简化错误类型
  - [ ] 更新文档

- [ ] 2.4.2 重构 `signature_type.go`
  - [ ] 更新版权声明
  - [ ] 确认类型定义

- [ ] 2.4.3 重构 `doc.go`
  - [ ] 更新版权声明
  - [ ] 重写包文档
  - [ ] 添加使用示例

### 2.5 测试完善
- [ ] 2.5.1 更新所有测试文件的版权声明
- [ ] 2.5.2 添加缺失的测试用例
- [ ] 2.5.3 运行完整测试套件
- [ ] 2.5.4 确保测试覆盖率 > 60%

## 阶段 3: 其他包重构

### 3.1 pkg/signer 处理
- [ ] 3.1.1 确认 `internal/signer` 功能完整性
- [ ] 3.1.2 检查 `pkg/signer` 的外部引用
- [ ] 3.1.3 决定删除或保留
  - [ ] 如删除：移除所有文件和引用
  - [ ] 如保留：作为 `internal/signer` 的包装层

### 3.2 pkg/s3utils 重构
- [ ] 3.2.1 更新版权声明
- [ ] 3.2.2 重构 URL 编码/解码函数
- [ ] 3.2.3 重构桶名验证
- [ ] 3.2.4 重构对象名验证
- [ ] 3.2.5 添加 RustFS 特定验证（如需要）
- [ ] 3.2.6 更新测试用例
- [ ] 3.2.7 更新文档

### 3.3 pkg/set 处理
- [ ] 3.3.1 检查使用情况
- [ ] 3.3.2 决定处理方案
  - [ ] 删除（如果未使用）
  - [ ] 移至 `internal/set`（如果仅内部使用）
  - [ ] 重构（如果需要保留）

## 阶段 4: 测试和文档

### 4.1 综合测试
- [ ] 4.1.1 运行所有单元测试
  ```bash
  go test ./pkg/... -v
  ```
- [ ] 4.1.2 运行集成测试
  ```bash
  go test ./... -v
  ```
- [ ] 4.1.3 运行示例程序
  ```bash
  go run -tags example examples/rustfs/bucketops.go
  go run -tags example examples/rustfs/objectops.go
  go run -tags example examples/rustfs/multipart.go
  go run -tags example examples/rustfs/health.go
  go run -tags example examples/rustfs/trace.go
  ```
- [ ] 4.1.4 检查测试覆盖率
  ```bash
  go test ./pkg/... -cover
  ```

### 4.2 文档更新
- [ ] 4.2.1 更新 `pkg/credentials/doc.go`
- [ ] 4.2.2 更新 `pkg/s3utils` 文档
- [ ] 4.2.3 更新 `README.md`（如需要）
- [ ] 4.2.4 更新 `CHANGELOG.md`
- [ ] 4.2.5 创建迁移指南（如有 API 变更）

### 4.3 代码质量检查
- [ ] 4.3.1 运行 linter
  ```bash
  golangci-lint run ./pkg/...
  ```
- [ ] 4.3.2 检查代码格式
  ```bash
  gofmt -l -w ./pkg/
  ```
- [ ] 4.3.3 运行 go vet
  ```bash
  go vet ./pkg/...
  ```

### 4.4 最终验证
- [ ] 4.4.1 确认所有 MinIO 版权声明已移除
- [ ] 4.4.2 确认所有 MinIO 命名已更新
- [ ] 4.4.3 确认所有测试通过
- [ ] 4.4.4 确认所有示例运行正常
- [ ] 4.4.5 确认文档完整准确

## 验收标准

### 代码质量
- [ ] 所有文件使用 RustFS 版权声明
- [ ] 移除所有 MinIO 特定命名（除环境变量兼容性）
- [ ] 代码格式符合 Go 规范
- [ ] 无 linter 错误或警告

### 测试覆盖
- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 60%
- [ ] 所有集成测试通过
- [ ] 所有示例程序运行正常

### 文档完整性
- [ ] 包文档更新完整
- [ ] API 文档准确
- [ ] 示例代码可用
- [ ] CHANGELOG 更新

### 功能完整性
- [ ] 所有核心功能正常工作
- [ ] 凭证管理功能完整
- [ ] S3 工具函数正常

## 时间估算

- **阶段 1**: 1-2 天
- **阶段 2**: 2-3 天
- **阶段 3**: 1-2 天
- **阶段 4**: 1 天
- **总计**: 5-8 天

## 注意事项

1. **保持 API 兼容性**: 公共 API 应保持不变，只重构内部实现
2. **测试优先**: 每个重构步骤都应该先运行测试
3. **增量提交**: 每完成一个模块就提交一次
4. **文档同步**: 代码和文档同步更新
5. **版权致谢**: 保留对 MinIO 的致谢，但明确 RustFS 的独立性
