# ææ¡ˆï¼šé‡æ„ pkg åŒ…æ¨¡å—

## å…ƒæ•°æ®

- **ææ¡ˆ ID**: `refactor-pkg-modules`
- **æ ‡é¢˜**: é‡æ„ pkg åŒ…æ¨¡å—ï¼Œç§»é™¤ MinIO ç‰ˆæƒï¼Œå®ç°è‡ªä¸»å®ç°
- **çŠ¶æ€**: è‰ç¨¿
- **åˆ›å»ºæ—¥æœŸ**: 2025-12-17
- **ä½œè€…**: RustFS Go SDK Team

## èƒŒæ™¯

å½“å‰ `pkg/` ç›®å½•ä¸‹çš„å¤šä¸ªåŒ…ï¼ˆcredentialsã€signerã€s3utilsã€set ç­‰ï¼‰ç›´æ¥ç»§æ‰¿è‡ª MinIO Go SDKï¼ŒåŒ…å« MinIO çš„ç‰ˆæƒä¿¡æ¯å’Œå®ç°ç»†èŠ‚ã€‚ä¸ºäº†ä½¿ RustFS Go SDK æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„ã€è‡ªä¸»å®ç°çš„é¡¹ç›®ï¼Œéœ€è¦å¯¹è¿™äº›åŒ…è¿›è¡Œå½»åº•é‡æ„ã€‚

### å½“å‰é—®é¢˜

1. **ç‰ˆæƒé—®é¢˜**: æ‰€æœ‰ pkg åŒ…éƒ½åŒ…å« MinIO çš„ç‰ˆæƒå£°æ˜
2. **ä»£ç ä¾èµ–**: éƒ¨åˆ†å®ç°ä¸ MinIO ç‰¹å®šåŠŸèƒ½å¼ºè€¦åˆ
3. **å‘½åæ··æ·†**: å¦‚ `EnvMinio`ã€`FileMinioClient` ç­‰å‘½åä¸ RustFS ä¸ç¬¦
4. **å†—ä½™ä»£ç **: åŒ…å«ä¸€äº› RustFS ä¸éœ€è¦çš„åŠŸèƒ½ï¼ˆå¦‚æŸäº› STS æ‰©å±•ï¼‰
5. **ç»´æŠ¤å›°éš¾**: ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£ä»å¼•ç”¨ MinIO

### ç›®æ ‡

1. å®Œå…¨ç§»é™¤ MinIO ç‰ˆæƒä¿¡æ¯ï¼Œä½¿ç”¨ RustFS è‡ªå·±çš„ç‰ˆæƒ
2. é‡æ–°å®ç°æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿ä»£ç ç‹¬ç«‹æ€§
3. ç»Ÿä¸€å‘½åè§„èŒƒï¼Œä½¿ç”¨ RustFS ç›¸å…³å‘½å
4. ç®€åŒ–ä»£ç ç»“æ„ï¼Œåªä¿ç•™ RustFS éœ€è¦çš„åŠŸèƒ½
5. æä¾›å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

## è¯¦ç»†è®¾è®¡

### 1. pkg/credentials åŒ…é‡æ„

**å½“å‰çŠ¶æ€**:
- åŒ…å« 20+ ä¸ªæ–‡ä»¶
- MinIO ç‰ˆæƒå£°æ˜
- æ”¯æŒå¤šç§å‡­è¯æä¾›è€…ï¼ˆAWS IAMã€MinIO STSã€æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ç­‰ï¼‰

**é‡æ„è®¡åˆ’**:

#### 1.1 ä¿ç•™å¹¶é‡æ„çš„æ ¸å¿ƒåŠŸèƒ½
- âœ… é™æ€å‡­è¯ (`static.go`)
- âœ… ç¯å¢ƒå˜é‡å‡­è¯ (`env_aws.go`, `env_minio.go` -> åˆå¹¶ä¸º `env.go`)
- âœ… æ–‡ä»¶å‡­è¯ (`file_aws_credentials.go`, `file_minio_client.go` -> åˆå¹¶ä¸º `file.go`)
- âœ… å‡­è¯é“¾ (`chain.go`)
- âœ… IAM å‡­è¯ (`iam_aws.go` -> `iam.go`)

#### 1.2 STS åŠŸèƒ½è¯„ä¼°
- ğŸ” `assume_role.go` - ä¿ç•™ï¼ˆS3 æ ‡å‡†åŠŸèƒ½ï¼‰
- ğŸ” `sts_web_identity.go` - ä¿ç•™ï¼ˆS3 æ ‡å‡†åŠŸèƒ½ï¼‰
- â“ `sts_client_grants.go` - è¯„ä¼°æ˜¯å¦éœ€è¦
- â“ `sts_custom_identity.go` - è¯„ä¼°æ˜¯å¦éœ€è¦
- â“ `sts_ldap_identity.go` - è¯„ä¼°æ˜¯å¦éœ€è¦
- â“ `sts_tls_identity.go` - è¯„ä¼°æ˜¯å¦éœ€è¦

#### 1.3 æ–°çš„æ–‡ä»¶ç»“æ„
```
pkg/credentials/
â”œâ”€â”€ credentials.go       # æ ¸å¿ƒæ¥å£å’Œç±»å‹
â”œâ”€â”€ static.go           # é™æ€å‡­è¯
â”œâ”€â”€ env.go              # ç¯å¢ƒå˜é‡å‡­è¯ï¼ˆåˆå¹¶ AWS å’Œ RustFSï¼‰
â”œâ”€â”€ file.go             # æ–‡ä»¶å‡­è¯ï¼ˆåˆå¹¶ AWS å’Œ RustFSï¼‰
â”œâ”€â”€ chain.go            # å‡­è¯é“¾
â”œâ”€â”€ iam.go              # IAM è§’è‰²å‡­è¯
â”œâ”€â”€ sts_assume_role.go  # STS AssumeRole
â”œâ”€â”€ sts_web_identity.go # STS Web Identity
â”œâ”€â”€ error.go            # é”™è¯¯ç±»å‹
â””â”€â”€ doc.go              # åŒ…æ–‡æ¡£
```

### 2. pkg/signer åŒ…é‡æ„

**å½“å‰çŠ¶æ€**:
- AWS Signature V2/V4 å®ç°
- æµå¼ç­¾åæ”¯æŒ
- MinIO ç‰ˆæƒå£°æ˜

**é‡æ„è®¡åˆ’**:

#### 2.1 è¯„ä¼°ä¸å†³ç­–
- âœ… å·²åœ¨ `internal/signer` å®ç°äº†æ–°çš„ç­¾åé€»è¾‘
- âŒ `pkg/signer` åº”è¯¥è¢«æ ‡è®°ä¸ºåºŸå¼ƒæˆ–åˆ é™¤
- ğŸ”„ å¦‚æœéœ€è¦ä¿ç•™ï¼Œåº”è¯¥ä½œä¸º `internal/signer` çš„å…¬å…± API åŒ…è£…

#### 2.2 å¤„ç†æ–¹æ¡ˆ
**é€‰é¡¹ A**: åˆ é™¤ `pkg/signer`ï¼Œå®Œå…¨ä½¿ç”¨ `internal/signer`
**é€‰é¡¹ B**: ä¿ç•™ `pkg/signer` ä½œä¸ºå…¬å…± APIï¼Œå†…éƒ¨è°ƒç”¨ `internal/signer`
**æ¨è**: é€‰é¡¹ Aï¼ˆå·²æœ‰ `internal/signer` å®Œæ•´å®ç°ï¼‰

### 3. pkg/s3utils åŒ…é‡æ„

**å½“å‰çŠ¶æ€**:
- S3 URL ç¼–ç /è§£ç 
- æ¡¶åéªŒè¯
- å¯¹è±¡åéªŒè¯
- MinIO ç‰ˆæƒå£°æ˜

**é‡æ„è®¡åˆ’**:

#### 3.1 åŠŸèƒ½è¯„ä¼°
- âœ… URL ç¼–ç /è§£ç  - ä¿ç•™ï¼ˆS3 æ ‡å‡†ï¼‰
- âœ… æ¡¶åéªŒè¯ - ä¿ç•™ï¼ˆS3 æ ‡å‡†ï¼‰
- âœ… å¯¹è±¡åéªŒè¯ - ä¿ç•™ï¼ˆS3 æ ‡å‡†ï¼‰

#### 3.2 é‡æ„æ–¹æ¡ˆ
- ç§»é™¤ MinIO ç‰ˆæƒ
- ç®€åŒ–å®ç°ï¼Œåªä¿ç•™æ ¸å¿ƒåŠŸèƒ½
- æ·»åŠ  RustFS ç‰¹å®šçš„éªŒè¯è§„åˆ™ï¼ˆå¦‚æœæœ‰ï¼‰

### 4. pkg/set åŒ…é‡æ„

**å½“å‰çŠ¶æ€**:
- å­—ç¬¦ä¸²é›†åˆå®ç°
- ä½¿ç”¨ msgp åºåˆ—åŒ–
- MinIO ç‰ˆæƒå£°æ˜

**é‡æ„è®¡åˆ’**:

#### 4.1 è¯„ä¼°
- â“ æ˜¯å¦çœŸæ­£éœ€è¦è¿™ä¸ªåŒ…ï¼Ÿ
- ğŸ” æ£€æŸ¥é¡¹ç›®ä¸­çš„ä½¿ç”¨æƒ…å†µ

#### 4.2 å¤„ç†æ–¹æ¡ˆ
**é€‰é¡¹ A**: åˆ é™¤ï¼ˆå¦‚æœæœªä½¿ç”¨ï¼‰
**é€‰é¡¹ B**: é‡æ„å¹¶ç§»é™¤ç‰ˆæƒï¼ˆå¦‚æœè¢«ä½¿ç”¨ï¼‰
**é€‰é¡¹ C**: ç§»è‡³ `internal/set`ï¼ˆå¦‚æœä»…å†…éƒ¨ä½¿ç”¨ï¼‰

### 5. å…¶ä»– pkg åŒ…å¤„ç†

#### 5.1 å·²åˆ é™¤çš„åŒ…
- âœ… `pkg/cors` - å·²åˆ é™¤
- âœ… `pkg/s3errors` - å·²åˆ é™¤
- âœ… `pkg/s3signer` - å·²åˆ é™¤

#### 5.2 å¾…è¯„ä¼°çš„åŒ…
æ£€æŸ¥ä»¥ä¸‹åŒ…æ˜¯å¦ä»ç„¶å­˜åœ¨ä¸”è¢«ä½¿ç”¨ï¼š
- `pkg/lifecycle`
- `pkg/notification`
- `pkg/policy`
- `pkg/replication`
- `pkg/encrypt`
- `pkg/kvcache`
- `pkg/singleflight`
- `pkg/sse`
- `pkg/tags`

## å®æ–½è®¡åˆ’

### é˜¶æ®µ 1: è¯„ä¼°å’Œæ¸…ç†ï¼ˆ1-2 å¤©ï¼‰
1. åˆ†ææ‰€æœ‰ pkg åŒ…çš„ä½¿ç”¨æƒ…å†µ
2. ç¡®å®šå“ªäº›åŒ…éœ€è¦ä¿ç•™
3. åˆ é™¤æœªä½¿ç”¨çš„åŒ…
4. åˆ¶å®šè¯¦ç»†çš„é‡æ„è®¡åˆ’

### é˜¶æ®µ 2: credentials åŒ…é‡æ„ï¼ˆ2-3 å¤©ï¼‰
1. åˆ›å»ºæ–°çš„ç‰ˆæƒå£°æ˜æ¨¡æ¿
2. é‡æ„é™æ€å‡­è¯
3. åˆå¹¶ç¯å¢ƒå˜é‡å‡­è¯
4. åˆå¹¶æ–‡ä»¶å‡­è¯
5. é‡æ„å‡­è¯é“¾
6. é‡æ„ IAM å‡­è¯
7. è¯„ä¼°å¹¶é‡æ„ STS åŠŸèƒ½
8. ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µ 3: å…¶ä»–åŒ…é‡æ„ï¼ˆ1-2 å¤©ï¼‰
1. å¤„ç† signer åŒ…ï¼ˆåˆ é™¤æˆ–é‡æ„ï¼‰
2. é‡æ„ s3utils åŒ…
3. å¤„ç† set åŒ…
4. æ¸…ç†å…¶ä»–æœªä½¿ç”¨çš„åŒ…

### é˜¶æ®µ 4: æµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ1 å¤©ï¼‰
1. è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
2. æ›´æ–°åŒ…æ–‡æ¡£
3. æ›´æ–° README
4. éªŒè¯æ‰€æœ‰ç¤ºä¾‹

## ç‰ˆæƒå£°æ˜æ¨¡æ¿

æ–°çš„ç‰ˆæƒå£°æ˜åº”è¯¥ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

```go
/*
 * RustFS Go SDK
 * Copyright 2025 RustFS Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
```


## é£é™©å’Œç¼“è§£

### é£é™© 1: åŠŸèƒ½å›å½’
**ç¼“è§£**:
- ä¿ç•™æ‰€æœ‰ç°æœ‰æµ‹è¯•
- æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹
- åœ¨é‡æ„å‰åè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

### é£é™© 2: API å…¼å®¹æ€§ç ´å
**ç¼“è§£**:
- ä¿æŒå…¬å…± API ä¸å˜
- åªé‡æ„å†…éƒ¨å®ç°

### é£é™© 3: æ—¶é—´ä¼°ç®—ä¸å‡†ç¡®
**ç¼“è§£**:
- åˆ†é˜¶æ®µå®æ–½
- æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥ç‹¬ç«‹äº¤ä»˜
- ä¼˜å…ˆå¤„ç†æ ¸å¿ƒåŠŸèƒ½

## æˆåŠŸæ ‡å‡†

1. âœ… æ‰€æœ‰ pkg åŒ…éƒ½ä½¿ç”¨ RustFS ç‰ˆæƒå£°æ˜
2. âœ… ç§»é™¤æ‰€æœ‰ MinIO ç‰¹å®šçš„å‘½åå’Œå¼•ç”¨
3. âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
4. âœ… ä»£ç è¦†ç›–ç‡ä¸ä½äºå½“å‰æ°´å¹³
5. âœ… æ‰€æœ‰ç¤ºä¾‹æ­£å¸¸è¿è¡Œ
6. âœ… æ–‡æ¡£æ›´æ–°å®Œæ•´

## å¾…å†³å®šäº‹é¡¹

1. ä¿ç•™æ‰€æœ‰ STS åŠŸèƒ½
2. `pkg/signer` åˆ é™¤ï¼Œä½†æ˜¯éœ€è¦ç”¨åˆ°çš„åŠŸèƒ½éœ€è¦ä¿ç•™åœ¨ `internal/signer` ä¸­
3. `pkg/set` åˆ é™¤ï¼Œä½†æ˜¯éœ€è¦ç”¨åˆ°çš„åŠŸèƒ½éœ€è¦ä¿ç•™åœ¨ `internal/set` ä¸­
4. æ˜¯å¦éœ€è¦æ·»åŠ  RustFS ç‰¹å®šçš„åŠŸèƒ½ï¼Ÿ

## å‚è€ƒèµ„æ–™

- [AWS SDK for Go - Credentials](https://github.com/aws/aws-sdk-go/tree/main/aws/credentials)
- [Apache License 2.0](https://www.apache.org/licenses/LICENSE-2.0)
- [Go Project Layout](https://github.com/golang-standards/project-layout)
